<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>await for a new async in Swift | kyryl horbushko</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="await for a new async in Swift" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Async tasks allow us to improve UX and use (or at least try to use) all possible power that the device could provide for us. Almost every app nowadays uses async code - from executing small, not important to heavy, possibly remote, tasks. Such behavior can greatly improve any flow and move u’r app to the next level." />
<meta property="og:description" content="Async tasks allow us to improve UX and use (or at least try to use) all possible power that the device could provide for us. Almost every app nowadays uses async code - from executing small, not important to heavy, possibly remote, tasks. Such behavior can greatly improve any flow and move u’r app to the next level." />
<link rel="canonical" href="http://localhost:4000/article/2021/02/15/await-for-future.html" />
<meta property="og:url" content="http://localhost:4000/article/2021/02/15/await-for-future.html" />
<meta property="og:site_name" content="kyryl horbushko" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-15T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="await for a new async in Swift" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/article/2021/02/15/await-for-future.html"},"@type":"BlogPosting","url":"http://localhost:4000/article/2021/02/15/await-for-future.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/favicon.png"}},"headline":"await for a new async in Swift","dateModified":"2021-02-15T00:00:00+02:00","datePublished":"2021-02-15T00:00:00+02:00","description":"Async tasks allow us to improve UX and use (or at least try to use) all possible power that the device could provide for us. Almost every app nowadays uses async code - from executing small, not important to heavy, possibly remote, tasks. Such behavior can greatly improve any flow and move u’r app to the next level.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="kyryl horbushko" />
<meta name='monetization' content='$ilp.uphold.com/GiEjnNF98h8k'>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">kyryl horbushko</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/bookNotes/">Books</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/blog/archives/">Archives</a><a class="page-link" href="/contact/">Contact</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">await for a new  async in Swift</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-02-15T00:00:00+02:00" itemprop="datePublished">
        Feb 15, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">kyryl horbushko</span></span>, 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Lviv</span></span></p>

      
         
          <a class="post-tag" href="/tags/#ios">iOS</a>
         
          <a class="post-tag" href="/tags/#swift">Swift</a>
         
          <a class="post-tag" href="/tags/#await-async">await/async</a>
         
      
         <span style="float:right;">
          <span class="ert">
    <abbr title="Estimated reading time">Estimated reading time: </abbr>
    
    
    
    

    
    
    

    
    7 minutes
</span>
         </span>
         <br>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <br>
    <ul>
  <li><a href="#the-problem">The problem</a></li>
  <li><a href="#asyncawait">Async/await</a>
    <ul>
      <li><a href="#task">Task</a></li>
      <li><a href="#actor">Actor</a></li>
      <li><a href="#convert-functions-into-new-async-code">Convert functions into new async code</a></li>
      <li><a href="#entry-point">Entry point</a></li>
    </ul>
  </li>
  <li><a href="#practice">Practice</a>
    <ul>
      <li><a href="#environment">Environment</a></li>
      <li><a href="#code-sample">Code sample</a></li>
    </ul>
  </li>
  <li><a href="#conclusion">Conclusion</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>
    <br>
    <p>Async tasks allow us to improve UX and use (or at least try to use) all possible power that the device could provide for us. Almost every app nowadays uses async code - from executing small, not important to heavy, possibly remote, tasks. Such behavior can greatly improve any flow and move u’r app to the next level.
<!--more--></p>

<h2 id="the-problem">The problem</h2>

<p>Async code with callbacks provides great power to us (such as run some part of code on another thread or auto handle completion of async code, or even the possibility to provide non-blocking behavior). However, with this power comes great irresponsibility - our code can have a lot of bad things like:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Pyramid_of_doom_(programming)">pyramid of doom</a> (A sequence of simple asynchronous operations often requires deeply-nested closures)</li>
  <li>unclear Error handling (Callbacks make error handling difficult and very verbose)</li>
  <li>errors in logic (sometimes callback calls can be missed in nested conditional flows - when use guard for example)</li>
  <li>poor maintenance, scalability, understanding, and readability</li>
  <li>hard conditional execution</li>
</ul>

<p>We have a lot of techniques to fix these issues:</p>

<ul>
  <li>shallow code</li>
  <li>pack u’r code into modules</li>
  <li>use the monad-like style for error/data handling</li>
  <li>limit nesting functions calls</li>
  <li>reuse code</li>
  <li>Result type</li>
</ul>

<p>For now, we have a few techniques that are used almost on an every-day basis - <a href="https://developer.apple.com/documentation/DISPATCH">GCD</a> and <a href="https://developer.apple.com/documentation/foundation/operationqueue">OperationQueue</a>. And they are great - easy to use, has a lot of possibilities, very flexible, has reach documentation, but… we still should remember about the problems that were mention before, and so, use additional techniques for resolving them.</p>

<blockquote>
  <p>This problem isn’t new. And in other languages there is a possible solution - async/await. For example - <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/async/">in c#</a>:</p>

  <p><em>provides an abstraction over asynchronous code. You write code as a sequence of statements, just like always. You can read that code as though each statement completes before the next begins. The compiler performs several transformations because some of those statements may start work and return a Task that represents the ongoing work.</em> (from the official doc).</p>
</blockquote>

<h2 id="asyncawait">Async/await</h2>

<p>Recently, <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md#motivation-completion-handlers-are-suboptimal">new proposal for Swift appears</a>.</p>

<p>Interesting. As for me - this looks like one of the biggest improvements during the last time for Swift language.</p>

<p>Let’s start from <code class="language-plaintext highlighter-rouge">_Concurrency</code> - this is an experimental framework, and so we can’t use it for any production code (API may be changed), but for a test, this works just fine.</p>

<h3 id="task">Task</h3>

<p>Here, we can find <code class="language-plaintext highlighter-rouge">Task</code> - a type that represents some kind of work. From doc - <em>” is the analog of a thread for asynchronous functions. All asynchronous functions run as part of some task.”</em></p>

<p>With this <code class="language-plaintext highlighter-rouge">Task</code> type we can run code using various options:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">runDetached</code> - run as is (not recommended)</li>
  <li><code class="language-plaintext highlighter-rouge">withDeadline</code> - execute a task with deadline restriction</li>
  <li><code class="language-plaintext highlighter-rouge">withGroup</code> - by grouping a few tasks</li>
</ul>

<blockquote>
  <p>In the declaration of these functions u can find a new attribute - <code class="language-plaintext highlighter-rouge">@concurrent</code>. I found <a href="https://forums.swift.org/t/pitch-4-concurrentvalue-and-concurrent-closures-evolution-pitches/44446/3">the interesting thread on Swift forum</a> related to this, also there is a note about this attribute - <em>“The purpose of <code class="language-plaintext highlighter-rouge">@concurrent</code> is to support function values that conform to <code class="language-plaintext highlighter-rouge">ConcurrentValue</code> and can therefore be used in contexts that require <code class="language-plaintext highlighter-rouge">ConcurrentValue</code>.”</em></p>

  <p><a href="https://docs.google.com/document/d/1m2fLLq9_ArY1ySt108soxOZNX7XT0ixMlNLFK08789M/edit"><code class="language-plaintext highlighter-rouge">ConcurrentValue</code></a> - this is protocol, that mark object as safe and ready for concurent operations (<em>“are safe to share across concurrently-executing code”</em> according to <a href="https://github.com/DougGregor/swift-evolution/blob/actors/proposals/nnnn-actors.md#cross-actor-references-and-concurrentvalue-types">proposal</a>).</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">Task</code> also has supportive functions and properties such as <code class="language-plaintext highlighter-rouge">currentPriority</code> or <code class="language-plaintext highlighter-rouge">cancel</code>/<code class="language-plaintext highlighter-rouge">sleep</code> etc. I believe this API will be extended to allow do same things as with <code class="language-plaintext highlighter-rouge">GCD</code> and <code class="language-plaintext highlighter-rouge">OperationQueue</code>.</p>

<h3 id="actor">Actor</h3>

<p>Another interesting type there - <code class="language-plaintext highlighter-rouge">Actor</code> - <em>“An actor is a form of class that protects access to its mutable state”</em> (<a href="https://github.com/DougGregor/swift-evolution/blob/actors/proposals/nnnn-actors.md#cross-actor-references-and-concurrentvalue-types">source</a>).</p>

<p>There is not much about this type in the current API, I believe it will be extended in the few next updates.</p>

<h3 id="convert-functions-into-new-async-code">Convert functions into new async code</h3>

<p>The last part, that needs to be mentions - is support for existing code. If u already has some asynchronous code with closure-based callback, we can use few functions for converting it to a new async way:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">func</span> <span class="n">withCheckedContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">function</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="kd">#function</span><span class="p">,</span> <span class="n">_</span> <span class="nv">body</span><span class="p">:</span> <span class="p">(</span><span class="kt">CheckedContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="n">async</span> <span class="o">-&gt;</span> <span class="kt">T</span>

<span class="kd">public</span> <span class="kd">func</span> <span class="n">withCheckedThrowingContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">function</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="kd">#function</span><span class="p">,</span> <span class="n">_</span> <span class="nv">body</span><span class="p">:</span> <span class="p">(</span><span class="kt">CheckedThrowingContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="n">async</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">T</span>

<span class="kd">public</span> <span class="kd">func</span> <span class="n">withUnsafeContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">fn</span><span class="p">:</span> <span class="p">(</span><span class="kt">UnsafeContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="n">async</span> <span class="o">-&gt;</span> <span class="kt">T</span>

<span class="kd">public</span> <span class="kd">func</span> <span class="n">withUnsafeThrowingContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">fn</span><span class="p">:</span> <span class="p">(</span><span class="kt">UnsafeThrowingContinuation</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="n">async</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">T</span></code></pre></figure>

<h3 id="entry-point">Entry point</h3>

<p>As mention in proposal <em>“Because only async code can call other async code, this proposal provides no way to initiate asynchronous code. This is intentional: all asynchronous code runs within the context of a “task””</em> (<a href="https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md#launching-async-tasks">source</a>).</p>

<p>This entry point may be an available function</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">public</span> <span class="kd">func</span> <span class="nf">runAsyncAndBlock</span><span class="p">(</span><span class="n">_</span> <span class="nv">asyncFun</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">()</span> <span class="n">async</span> <span class="o">-&gt;</span> <span class="p">())</span></code></pre></figure>

<h2 id="practice">Practice</h2>

<p>Better - is always to test the code - run it and feel the power :].</p>

<h3 id="environment">Environment</h3>

<p>To test await/async we should install beta toolchain from <a href="https://swift.org/download/#snapshots">here</a>. Just scroll to Trunk development (main) and download the latest version. Then install the package and switch to it in xCode settings.</p>

<p>If u do everything fine, then u can see blue chain link in status bar of xCode project:</p>

<div style="text-align:center">
<img src="/assets/posts/images/2021-02-15-await-for-future/toolchain.png" alt="toolchain" width="550" />
</div>
<p><br /></p>

<p>To use async/await in a project u have few options - use it in swift package or in the project. In both cases, u should add <code class="language-plaintext highlighter-rouge">-Xfrontend -enable-experimental-concurrency</code>.</p>

<p>Put it in <code class="language-plaintext highlighter-rouge">Other Swift flags</code> in build settings for a project.</p>

<div style="text-align:center">
<img src="/assets/posts/images/2021-02-15-await-for-future/proj-flag.png" alt="proj-flag" width="550" />
</div>
<p><br /></p>

<p>For SP, for selected target add:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift">    <span class="o">.</span><span class="nf">unsafeFlags</span><span class="p">([</span>
        <span class="s">"-Xfrontend"</span><span class="p">,</span>
        <span class="s">"-enable-experimental-concurrency"</span>
    <span class="p">])</span></code></pre></figure>

<div style="text-align:center">
<img src="/assets/posts/images/2021-02-15-await-for-future/sp_flag.png" alt="sp_flag" width="550" />
</div>
<p><br /></p>

<h3 id="code-sample">Code sample</h3>

<p>The easiest variant - to use Task, that can be run in place:</p>

<p>We can define next function:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">runMeAsync</span><span class="p">()</span> <span class="n">async</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="k">in</span> <span class="mi">1</span><span class="o">...</span><span class="mi">3</span> <span class="p">{</span>
        <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">idx</span><span class="se">)</span><span class="s"> at </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>If we try just to run it we will get an error:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="nf">runMeAsync</span><span class="p">()</span> <span class="c1">// ERR: 'async' in a function that does not support concurrency</span></code></pre></figure>

<p>Even with <code class="language-plaintext highlighter-rouge">async</code> from <code class="language-plaintext highlighter-rouge">Dispatch</code>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
    <span class="n">await</span> <span class="nf">runMeAsync</span><span class="p">()</span> <span class="c1">// ERR: Invalid conversion from 'async' function of type '() async -&gt; Void' to synchronous function type '@convention(block) () -&gt; Void'</span>
<span class="p">}</span></code></pre></figure>

<p>As I mention above, we need to get an entry point for the async code.</p>

<p>We can either:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">handle</span> <span class="o">=</span> <span class="kt">Task</span><span class="o">.</span><span class="nf">runDetached</span><span class="p">(</span><span class="nv">operation</span><span class="p">:</span> <span class="p">{</span>
    <span class="n">await</span> <span class="nf">runMeAsync</span><span class="p">()</span>
<span class="p">})</span></code></pre></figure>

<p>or</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">runAsyncAndBlock</span> <span class="p">{</span>
    <span class="k">try</span><span class="p">?</span> <span class="n">await</span> <span class="nf">runMeAsync</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure>

<p>Both will run just fine and provide the next output:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">Hello</span><span class="p">,</span> <span class="n">world</span><span class="o">!</span>
<span class="mi">1</span> <span class="n">at</span> <span class="mi">2021</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">15</span> <span class="mo">03</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">22</span> <span class="o">+</span><span class="mo">0000</span>
<span class="mi">2</span> <span class="n">at</span> <span class="mi">2021</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">15</span> <span class="mo">03</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">23</span> <span class="o">+</span><span class="mo">0000</span>
<span class="mi">3</span> <span class="n">at</span> <span class="mi">2021</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">15</span> <span class="mo">03</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">24</span> <span class="o">+</span><span class="mo">0000</span>
<span class="kt">Program</span> <span class="n">ended</span> <span class="n">with</span> <span class="n">exit</span> <span class="nv">code</span><span class="p">:</span> <span class="mi">0</span></code></pre></figure>

<p>Now, case when we want to reuse existing code:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">doSomething</span><span class="p">(</span><span class="n">_</span> <span class="nv">callback</span><span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">())?)</span> <span class="p">{</span>
    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="nf">asyncAfter</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"from </span><span class="se">\(</span><span class="kd">#function</span><span class="se">)</span><span class="s"> </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="nf">callback</span><span class="p">?()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">doSomethingAsync</span><span class="p">()</span> <span class="n">async</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">withUnsafeContinuation</span> <span class="p">{</span> <span class="n">continuation</span> <span class="k">in</span>
        <span class="n">doSomething</span> <span class="p">{</span>
            <span class="n">continuation</span><span class="o">.</span><span class="nf">resume</span><span class="p">(</span><span class="nv">returning</span><span class="p">:</span> <span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">runAsyncAndBlock</span> <span class="p">{</span>
    <span class="n">await</span> <span class="nf">doSomethingAsync</span><span class="p">()</span>
<span class="p">}</span></code></pre></figure>

<p>and result is:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">from</span> <span class="nf">doSomething</span><span class="p">(</span><span class="nv">_</span><span class="p">:)</span> <span class="mi">2021</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">15</span> <span class="mo">04</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">38</span> <span class="o">+</span><span class="mo">0000</span>
<span class="kt">Program</span> <span class="n">ended</span> <span class="n">with</span> <span class="n">exit</span> <span class="nv">code</span><span class="p">:</span> <span class="mi">0</span></code></pre></figure>

<p>What, if we want to use result of some <code class="language-plaintext highlighter-rouge">async</code> function after <code class="language-plaintext highlighter-rouge">await</code>? Use <code class="language-plaintext highlighter-rouge">@asyncHandler</code>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">doSomething</span><span class="p">(</span><span class="n">_</span> <span class="nv">callback</span><span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="p">())?)</span> <span class="p">{</span>
    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="nf">asyncAfter</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"from </span><span class="se">\(</span><span class="kd">#function</span><span class="se">)</span><span class="s"> </span><span class="se">\(</span><span class="kt">Date</span><span class="p">()</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="nf">callback</span><span class="p">?()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">doSomethingAsync2</span><span class="p">()</span> <span class="n">async</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="n">await</span> <span class="n">withUnsafeContinuation</span> <span class="p">{</span> <span class="n">continuation</span> <span class="k">in</span>
        <span class="n">doSomething</span> <span class="p">{</span>
            <span class="n">continuation</span><span class="o">.</span><span class="nf">resume</span><span class="p">(</span><span class="nv">returning</span><span class="p">:</span> <span class="kd">#function</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">@asyncHandler</span> <span class="kd">func</span> <span class="nf">doSomethingWithAsyncDataInsideFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">await</span> <span class="nf">doSomethingAsync2</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"The result is </span><span class="se">\(</span><span class="n">result</span><span class="se">)</span><span class="s">, obtained in </span><span class="se">\(</span><span class="kd">#function</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">doSomethingWithAsyncDataInsideFunction</span><span class="p">()</span></code></pre></figure>

<p>output:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">Hello</span><span class="p">,</span> <span class="n">world</span><span class="o">!</span>
<span class="n">from</span> <span class="nf">doSomething</span><span class="p">(</span><span class="nv">_</span><span class="p">:)</span> <span class="mi">2021</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">15</span> <span class="mo">04</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mo">00</span> <span class="o">+</span><span class="mo">0000</span>
<span class="kt">The</span> <span class="n">result</span> <span class="k">is</span> <span class="kt">Optional</span><span class="p">(</span><span class="s">"doSomethingAsync2()"</span><span class="p">),</span> <span class="n">obtained</span> <span class="k">in</span> <span class="nf">doSomethingWithAsyncDataInsideFunction</span><span class="p">()</span>
<span class="kt">Program</span> <span class="n">ended</span> <span class="n">with</span> <span class="n">exit</span> <span class="nv">code</span><span class="p">:</span> <span class="mi">0</span></code></pre></figure>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">@asyncHandler</code> functions cannot be marked as <code class="language-plaintext highlighter-rouge">async</code></p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>As for me, this is a great improvement, that provides a better and more convenience way of async code handling. Can’t await when it to become available :].</p>

<p><a href="/assets/posts/images/2021-02-15-await-for-future/source/async-test.zip">download source code</a></p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0296-async-await.md#motivation-completion-handlers-are-suboptimal">Async/await for Swift</a></li>
  <li><a href="https://github.com/peterfriese/Swift-Async-Await-Experiments">Async-await experiment</a></li>
  <li><a href="https://swift.org/download/#releases">Toolchain download page</a></li>
  <li><a href="https://peterfriese.dev/async-await-in-swiftui/">Using async/await in SwiftUI</a></li>
  <li><a href="https://github.com/DougGregor/swift-evolution/blob/structured-concurrency/proposals/nnnn-structured-concurrency.md">Task API and Structured Concurrency</a></li>
  <li><a href="https://github.com/DougGregor/swift-evolution/blob/concurrency-objc/proposals/NNNN-concurrency-objc.md">Concurrency Interoperability with Objective-C</a></li>
  <li><a href="https://docs.google.com/document/d/1m2fLLq9_ArY1ySt108soxOZNX7XT0ixMlNLFK08789M/edit"><code class="language-plaintext highlighter-rouge">ConcurrentValue</code></a></li>
  <li><a href="https://forums.swift.org/t/se-0296-async-await/42605/206">SE-0296: async/await SF</a></li>
  <li><a href="https://www.enekoalonso.com/articles/getting-started-with-async-await-in-swift">Getting started with async/await in Swift</a></li>
  <li><a href="https://forums.swift.org/t/simple-example-involving-structured-concurrency/43424/2">Simple example involving structured concurrency</a></li>
  <li><a href="https://forums.swift.org/t/pitch-4-concurrentvalue-and-concurrent-closures-evolution-pitches/44446">Pitch #4: ConcurrentValue and @concurrent closures Evolution Pitches</a></li>
</ul>

  </div><a class="u-url" href="/article/2021/02/15/await-for-future.html" hidden></a>
</article>

<div class="prev-next">
  
    <a class="half prev" href="/article/2021/02/09/powerful-trio.html">&laquo; Powerful trio</a>
  
  
    <a class="half next" href="/article/2021/02/20/save-resources.html">Save resources &raquo;</a>
  
</div>




<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=http://localhost:4000/article/2021/02/15/await-for-future.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=http://localhost:4000/article/2021/02/15/await-for-future.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/article/2021/02/15/await-for-future.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    
    <div class="gplus" title="Share this on Google Plus" onclick="window.open('https://plus.google.com/share?url=http://localhost:4000/article/2021/02/15/await-for-future.html');"><svg viewBox="0 0 2304 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1437 913q0 208-87 370.5t-248 254-369 91.5q-149 0-285-58t-234-156-156-234-58-285 58-285 156-234 234-156 285-58q286 0 491 192l-199 191q-117-113-292-113-123 0-227.5 62t-165.5 168.5-61 232.5 61 232.5 165.5 168.5 227.5 62q83 0 152.5-23t114.5-57.5 78.5-78.5 49-83 21.5-74h-416v-252h692q12 63 12 122zm867-122v210h-209v209h-210v-209h-209v-210h209v-209h210v209h209z"/></svg></div>
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=http://localhost:4000/article/2021/02/15/await-for-future.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

<script src="  https://unpkg.com/showdown/dist/showdown.min.js"></script>
<script>
const GH_API_URL = 'https://api.github.com/repos/khorbushko/khorbushko.github.io/issues/29/comments'; // ?client_id=&client_secret=

let request = new XMLHttpRequest();
request.open( 'GET', GH_API_URL, true );
request.onload = function() {
	if ( this.status >= 200 && this.status < 400 ) {
		let response = JSON.parse( this.response );

		for ( var i = 0; i < response.length; i++ ) {
			document.getElementById( 'gh-comments-list' ).appendChild( createCommentEl( response[ i ] ) );
		}

		if ( 0 === response.length ) {
			document.getElementById( 'no-comments-found' ).style.display = 'block';
		}
	} else {
		console.error( this );
	}
};

function createCommentEl( response ) {
	let user = document.createElement( 'a' );
	user.setAttribute( 'href', response.user.url.replace( 'api.github.com/users', 'github.com' ) );
	user.classList.add( 'user' );

	let userAvatar = document.createElement( 'img' );
	userAvatar.classList.add( 'avatar' );
	userAvatar.setAttribute( 'src', response.user.avatar_url );

	user.appendChild( userAvatar );

	let commentLink = document.createElement( 'a' );
	commentLink.setAttribute( 'href', response.html_url );
	commentLink.classList.add( 'comment-url' );
	commentLink.innerHTML = '#' + response.id + ' - ' + response.created_at;

	let commentContents = document.createElement( 'div' );
	commentContents.classList.add( 'comment-content' );
	commentContents.innerHTML = response.body;
	// Progressive enhancement.
	if ( window.showdown ) {
		let converter = new showdown.Converter();
		commentContents.innerHTML = converter.makeHtml( response.body );
	}

	let comment = document.createElement( 'li' );
	comment.setAttribute( 'data-created', response.created_at );
	comment.setAttribute( 'data-author-avatar', response.user.avatar_url );
	comment.setAttribute( 'data-user-url', response.user.url );

	comment.appendChild( user );
	comment.appendChild( commentContents );
	comment.appendChild( commentLink );

	return comment;
}
request.send();
</script>

<hr>

<div class="github-comments">
	<h2>Comments</h2>
	<ul id="gh-comments-list"></ul>
	<p id="leave-a-comment">Join the discussion for this article on <a href="https://github.com/khorbushko/khorbushko.github.io/issues/29">this ticket</a>. Comments appear on this page instantly.</p>
</div>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>RSS</span>      
          </a>
          &nbsp;&nbsp;
          <a href="https://feedrabbit.com/?url=http://khorbushko.github.io">
            <svg class="svg-icon black">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Newsletter</span>      
          </a>

        </p>
        <ul class="contact-list">
          <li class="p-name">khorbushko</li>
          <li><a class="u-email" href="mailto:kirill.ge@gmail.com">kirill.ge@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>inspired by &quot;software craftsmanship&quot;</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/khorbushko" title="khorbushko"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://stackoverflow.com/users/2012219" title="2012219"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/kyryl-horbushko-67936bb5" title="kyryl-horbushko-67936bb5"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

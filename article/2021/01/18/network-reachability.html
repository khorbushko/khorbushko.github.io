<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Network reachability | kyryl horbushko</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Network reachability" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Now, networking is one of the core components of almost any mobile app. Most applications store, retrieve, analyze, and provide data to u using a network connection. Without networking, most apps can’t exist at all. Different situations may occur and apps may be used in a different location with or without an internet connection. Sometimes we would like to notify the user that some connection interruptions have been detected and so the work of the app may be unstable. This indeed improves UX." />
<meta property="og:description" content="Now, networking is one of the core components of almost any mobile app. Most applications store, retrieve, analyze, and provide data to u using a network connection. Without networking, most apps can’t exist at all. Different situations may occur and apps may be used in a different location with or without an internet connection. Sometimes we would like to notify the user that some connection interruptions have been detected and so the work of the app may be unstable. This indeed improves UX." />
<link rel="canonical" href="http://localhost:4000/article/2021/01/18/network-reachability.html" />
<meta property="og:url" content="http://localhost:4000/article/2021/01/18/network-reachability.html" />
<meta property="og:site_name" content="kyryl horbushko" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-18T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Network reachability" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/article/2021/01/18/network-reachability.html"},"@type":"BlogPosting","url":"http://localhost:4000/article/2021/01/18/network-reachability.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/favicon.png"}},"headline":"Network reachability","dateModified":"2021-01-18T00:00:00+02:00","datePublished":"2021-01-18T00:00:00+02:00","description":"Now, networking is one of the core components of almost any mobile app. Most applications store, retrieve, analyze, and provide data to u using a network connection. Without networking, most apps can’t exist at all. Different situations may occur and apps may be used in a different location with or without an internet connection. Sometimes we would like to notify the user that some connection interruptions have been detected and so the work of the app may be unstable. This indeed improves UX.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css">
  <link rel="shortcut icon" type="image/png" href="/assets/favicon.png"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="kyryl horbushko" />
<meta name='monetization' content='$ilp.uphold.com/GiEjnNF98h8k'>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">kyryl horbushko</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/bookNotes/">Books</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/blog/archives/">Archives</a><a class="page-link" href="/contact/">Contact</a><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Network reachability</h1>
    <p class="post-meta"><time class="dt-published" datetime="2021-01-18T00:00:00+02:00" itemprop="datePublished">
        Jan 18, 2021
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">kyryl horbushko</span></span>, 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Lviv</span></span></p>

      
         
          <a class="post-tag" href="/tags/#ios">iOS</a>
         
          <a class="post-tag" href="/tags/#systemconfiguration">SystemConfiguration</a>
         
          <a class="post-tag" href="/tags/#network">Network</a>
         
          <a class="post-tag" href="/tags/#combine">Combine</a>
         
      
         <span style="float:right;">
          <span class="ert">
    <abbr title="Estimated reading time">Estimated reading time: </abbr>
    
    
    
    

    
    
    

    
    10 minutes
</span>
         </span>
         <br>
      </p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <br>
    <ul>
  <li><a href="#networkreachabilityprovider">NetworkReachabilityProvider</a></li>
  <li><a href="#systemconfiguration">SystemConfiguration</a>
    <ul>
      <li><a href="#implementation">Implementation</a></li>
      <li><a href="#3rd-party-solutions">3rd party solutions</a></li>
    </ul>
  </li>
  <li><a href="#network">Network</a></li>
  <li><a href="#resources">Resources</a></li>
</ul>
    <br>
    <p>Now, networking is one of the core components of almost any mobile app. Most applications store, retrieve, analyze, and provide data to u using a network connection. Without networking, most apps can’t exist at all.</p>

<p>Different situations may occur and apps may be used in a different location with or without an internet connection. Sometimes we would like to notify the user that some connection interruptions have been detected and so the work of the app may be unstable. This indeed improves UX. 
<!--more--></p>

<p>I don’t want to cover good practices related to network connectivity usage - what we should do and what shouldn’t, instead, I just want to cover the part that allows performing check the connection itself.</p>

<blockquote>
  <p>In case if u have some doubts about the network connectivity checking process, I can only recommend review networking documentation available <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternetWeb/Conceptual/NetworkingOverview/WhyNetworkingIsHard/WhyNetworkingIsHard.html#//apple_ref/doc/uid/TP40010220-CH13-SW2">here</a> and review Apple WWDC video (<a href="https://developer.apple.com/videos/play/wwdc2019/712/">#712</a>, <a href="https://developer.apple.com/videos/play/wwdc2019/713/">#713</a>)</p>

</blockquote>

<p>I should also mention that according to doc:</p>

<blockquote>
  <p><em>” Checking the reachability flag does not guarantee that your traffic will never be sent over a cellular connection.”</em></p>
</blockquote>

<p>So my advice before we start - make sure that the purpose of the network connection checking process does not reduce the functionality of your app, and u use it just as an informative mechanism, in other cases u can <em>lie</em> to your user and provide poor UX.</p>

<p>The most popular ways to check internet connection are created thanks to next frameworks:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SystemConfiguration</code></li>
  <li><code class="language-plaintext highlighter-rouge">Network</code></li>
</ul>

<h2 id="networkreachabilityprovider">NetworkReachabilityProvider</h2>

<p>Before we dive into details of each framework usage, we may want to configure some requirements for our NetworkStatus monitor. I have created <code class="language-plaintext highlighter-rouge">NetworkReachabilityProvider</code> protocol, that describes a possible way of determining information about network connection change:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">Combine</span>

<span class="kd">protocol</span> <span class="kt">NetworkReachabilityProvider</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">networkStatusHandler</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">stopListening</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">startListening</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="kt">NetworkReachabilityStatus</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="kt">ConnectionType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">ethernetOrWiFi</span>
        <span class="k">case</span> <span class="n">wwan</span>
    <span class="p">}</span>
    
    <span class="k">case</span> <span class="n">unknown</span>
    <span class="k">case</span> <span class="n">notReachable</span>
    <span class="k">case</span> <span class="nf">reachable</span><span class="p">(</span><span class="kt">ConnectionType</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>As u can see, this protocol requires that we start and stop monitoring and does not provide u current state. Instead <code class="language-plaintext highlighter-rouge">networkStatusHandler</code> will return u current state as soon as u start listening.</p>

<p>U may found such a way not useful for some cases - for example when u need to know instantly the status of a network connection. But I do this intentionally because u shouldn’t have such a situation at all - remember that I mention above <em>“make sure that purpose of network connection checking process does not reduce the functionality of your app”</em>. So u don’t need to know the instant status at all. And for informative purposes, u can use listeners and appropriate publishers.</p>

<blockquote>
  <p>A good point to mention - there are a lot of discussions about reachability (<a href="https://www.vadimbulavin.com/network-connectivity-on-ios-with-swift/">here</a> and <a href="https://www.mikeash.com/pyblog/friday-qa-2013-06-14-reachability.html">here</a> for example) and it’s non 100% precise result. And this is one more reason to not use this option for controlling how u logic works. Instead, better use the post-factum result of network requests and adjust logic using actual and REAL results.</p>
</blockquote>

<h2 id="systemconfiguration">SystemConfiguration</h2>

<p>This framework provides for us various mechanisms that <em>allow applications to access a device’s network configuration settings</em>.</p>

<blockquote>
  <p>The System Configuration framework provides powerful, flexible support for establishing and maintaining access to a configurable network and system resources. It offers your application the ability to determine, set, and maintain configuration settings and to detect and respond dynamically to changes in that information. <a href="https://developer.apple.com/library/archive/documentation/Networking/Conceptual/SystemConfigFrameworks/SC_Intro/SC_Intro.html#//apple_ref/doc/uid/TP40001065">more</a></p>

  <p><a href="https://developer.apple.com/documentation/systemconfiguration">reference to api</a></p>
</blockquote>

<p>The most interesting part for us - is the chapter dedicated to reachability - <a href="https://developer.apple.com/library/archive/documentation/Networking/Conceptual/SystemConfigFrameworks/SC_ReachConnect/SC_ReachConnect.html#//apple_ref/doc/uid/TP40001065-CH204-BHAFBAHI">Determining Reachability and Getting Connected</a>. According to it we should perform a few main steps to get things done:</p>

<ul>
  <li>Create a reference for your target remote host you can use in other reachability functions.</li>
  <li>Add the target to your run loop.</li>
  <li>Provide a callback function that’s called when the reachability status of your target changes.</li>
  <li>Determine if the target is reachable.</li>
</ul>

<h3 id="implementation">Implementation</h3>

<p>The API allows us to use network host or node name <a href="https://developer.apple.com/documentation/systemconfiguration/1514904-scnetworkreachabilitycreatewithn?language=objc"><code class="language-plaintext highlighter-rouge">SCNetworkReachabilityCreateWithName</code></a> we want to check or using the specified network address struct <code class="language-plaintext highlighter-rouge">sockaddr_in</code> - <a href="https://developer.apple.com/documentation/systemconfiguration/1514895-scnetworkreachabilitycreatewitha?language=objc"><code class="language-plaintext highlighter-rouge">SCNetworkReachabilityCreateWithAddress</code></a>. Third option - <a href="https://developer.apple.com/documentation/systemconfiguration/1514908-scnetworkreachabilitycreatewitha?language=objc"><code class="language-plaintext highlighter-rouge">SCNetworkReachabilityCreateWithAddressPair</code></a> - allow to create a reachability reference to the specified network address.</p>

<blockquote>
  <p>Checking host sometimes is useful, but this means that logic will depend on the availability of some host.</p>
</blockquote>

<p>I prefer to use <code class="language-plaintext highlighter-rouge">SCNetworkReachabilityCreateWithAddress</code> - this does not require any host specification or specific network address.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// Socket address, internet style</span>
<span class="k">var</span> <span class="nv">initialAddress</span> <span class="o">=</span> <span class="nf">sockaddr_in</span><span class="p">()</span>
<span class="c1">// The length member, sin_len, was added with 4.3BSD-Reno,</span>
<span class="c1">// when support for the OSI protocols was added</span>
<span class="n">initialAddress</span><span class="o">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="n">sockaddr_in</span><span class="o">&gt;.</span><span class="n">size</span><span class="p">)</span>
<span class="c1">// internetwork: UDP, TCP, etc</span>
<span class="n">initialAddress</span><span class="o">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="nf">sa_family_t</span><span class="p">(</span><span class="kt">AF_INET</span><span class="p">)</span>
    
<span class="k">if</span> <span class="k">let</span> <span class="nv">initialReachability</span><span class="p">:</span> <span class="kt">SCNetworkReachability</span> <span class="o">=</span>
    <span class="nf">withUnsafePointer</span><span class="p">(</span>
        <span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">initialAddress</span><span class="p">,</span> <span class="p">{</span>
            <span class="nv">$0</span><span class="o">.</span><span class="nf">withMemoryRebound</span><span class="p">(</span>
                <span class="nv">to</span><span class="p">:</span> <span class="n">sockaddr</span><span class="o">.</span><span class="k">self</span><span class="p">,</span>
                <span class="nv">capacity</span><span class="p">:</span> <span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="n">sockaddr</span><span class="o">&gt;.</span><span class="n">size</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="kt">SCNetworkReachabilityCreateWithAddress</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">})</span> <span class="p">{</span>
   <span class="c1">// do next steps...</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="c1">// handle failure...</span>
<span class="p">}</span></code></pre></figure>

<p>Using <code class="language-plaintext highlighter-rouge">SCNetworkReachability</code> we can extract <code class="language-plaintext highlighter-rouge">SCNetworkReachabilityFlags</code> and retrive current state of network connectivity status:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nv">flags</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">()</span>
<span class="k">if</span> <span class="kt">SCNetworkReachabilityGetFlags</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">flags</span>
<span class="p">}</span></code></pre></figure>

<p>Function to retrive status may be done as next:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">private</span> <span class="kd">func</span> <span class="nf">reachabilityOfNetworkFor</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NetworkReachabilityStatus</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">networkStatus</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">unknown</span>
    
    <span class="k">let</span> <span class="nv">isReachable</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">reachable</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">needsConnection</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">connectionRequired</span><span class="p">)</span>
    
    <span class="k">let</span> <span class="nv">canConnectAutomatically</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">connectionOnDemand</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">connectionOnTraffic</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">canConnectWithoutUserInteraction</span> <span class="o">=</span> <span class="n">canConnectAutomatically</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">interventionRequired</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">isNetworkAvailableFlag</span> <span class="o">=</span> <span class="n">isReachable</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="o">!</span><span class="n">needsConnection</span> <span class="o">||</span> <span class="n">canConnectWithoutUserInteraction</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">isNetworkAvailableFlag</span> <span class="p">{</span>
        <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">ethernetOrWiFi</span><span class="p">)</span>
        
        <span class="cp">#if os(iOS)</span>
        <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">isWWAN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">wwan</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="cp">#endif</span>
        
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">notReachable</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">networkStatus</span>
<span class="p">}</span></code></pre></figure>

<p>This is all good, but we also would like to be informed when something changed. To configure such behavior we may use <a href="https://developer.apple.com/documentation/systemconfiguration/1514903-scnetworkreachabilitysetcallback?language=objc"><code class="language-plaintext highlighter-rouge">SCNetworkReachabilitySetCallback</code></a>.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityContext</span><span class="p">(</span>
    <span class="nv">version</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nv">info</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">retain</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">release</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="nv">copyDescription</span><span class="p">:</span> <span class="kc">nil</span>
<span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kt">Unmanaged</span><span class="o">.</span><span class="nf">passUnretained</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="o">.</span><span class="nf">toOpaque</span><span class="p">()</span>
    
<span class="k">let</span> <span class="nv">callbackEnabled</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilitySetCallback</span><span class="p">(</span>
    <span class="n">reachability</span><span class="p">,</span>
    <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">info</span> <span class="o">=</span> <span class="n">info</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">reachability</span> <span class="o">=</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">NetworkReachability</span><span class="o">&gt;</span>
                <span class="o">.</span><span class="nf">fromOpaque</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">takeUnretainedValue</span><span class="p">()</span>
            <span class="n">reachability</span><span class="o">.</span><span class="nf">notifyListener</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="o">&amp;</span><span class="n">context</span>
<span class="p">)</span>
    
<span class="k">let</span> <span class="nv">queueEnabled</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilitySetDispatchQueue</span><span class="p">(</span>
    <span class="n">reachability</span><span class="p">,</span>
    <span class="n">handlerQueue</span>
<span class="p">)</span>
    
<span class="n">handlerQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
    <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">notifyListener</span><span class="p">(</span><span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">flagsForCurrentReachability</span> <span class="p">??</span> <span class="o">.</span><span class="nf">init</span><span class="p">())</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
  <p>Alternative way is to use <a href="https://developer.apple.com/documentation/systemconfiguration/1514894-scnetworkreachabilityschedulewit?language=objc"><code class="language-plaintext highlighter-rouge">SCNetworkReachabilityScheduleWithRunLoop</code></a> instead of <a href="https://developer.apple.com/documentation/systemconfiguration/1514911-scnetworkreachabilitysetdispatch?language=objc"><code class="language-plaintext highlighter-rouge">SCNetworkReachabilitySetDispatchQueue</code></a>. I prefere use <code class="language-plaintext highlighter-rouge">DispatchQueue</code>, bacause configuration is much easier.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">notifyListener</code> is a function that simply analyzes new flags and posts updates.</p>

<p>And we also need to have an option to stop the process:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kt">SCNetworkReachabilitySetCallback</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="kt">SCNetworkReachabilitySetDispatchQueue</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span></code></pre></figure>

<p>Putting all together we can get next:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">SystemConfiguration</span>
<span class="kd">import</span> <span class="kt">Combine</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">NetworkReachability</span><span class="p">:</span> <span class="kt">NetworkReachabilityProvider</span> <span class="p">{</span>
    
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">networkStatusHandler</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">handlerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">reachability</span><span class="p">:</span> <span class="kt">SCNetworkReachability</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">previousFlags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">reachabilityNotifier</span><span class="p">:</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">flagsForCurrentReachability</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">flags</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">()</span>
        <span class="k">if</span> <span class="kt">SCNetworkReachabilityGetFlags</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">flags</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Lifecycle</span>
    
    <span class="kd">convenience</span> <span class="nf">init</span><span class="p">?()</span> <span class="p">{</span>
        <span class="c1">// Socket address, internet style</span>
        <span class="k">var</span> <span class="nv">initialAddress</span> <span class="o">=</span> <span class="nf">sockaddr_in</span><span class="p">()</span>
        <span class="c1">// The length member, sin_len, was added with 4.3BSD-Reno,</span>
        <span class="c1">// when support for the OSI protocols was added</span>
        <span class="n">initialAddress</span><span class="o">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="n">sockaddr_in</span><span class="o">&gt;.</span><span class="n">size</span><span class="p">)</span>
        <span class="c1">// internetwork: UDP, TCP, etc</span>
        <span class="n">initialAddress</span><span class="o">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="nf">sa_family_t</span><span class="p">(</span><span class="kt">AF_INET</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">initialReachability</span><span class="p">:</span> <span class="kt">SCNetworkReachability</span> <span class="o">=</span>
            <span class="nf">withUnsafePointer</span><span class="p">(</span>
                <span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">initialAddress</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nv">$0</span><span class="o">.</span><span class="nf">withMemoryRebound</span><span class="p">(</span>
                        <span class="nv">to</span><span class="p">:</span> <span class="n">sockaddr</span><span class="o">.</span><span class="k">self</span><span class="p">,</span>
                        <span class="nv">capacity</span><span class="p">:</span> <span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="n">sockaddr</span><span class="o">&gt;.</span><span class="n">size</span>
                    <span class="p">)</span> <span class="p">{</span>
                        <span class="kt">SCNetworkReachabilityCreateWithAddress</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nv">$0</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">})</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">reachability</span><span class="p">:</span> <span class="n">initialReachability</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="nf">init</span><span class="p">(</span><span class="nv">reachability</span><span class="p">:</span> <span class="kt">SCNetworkReachability</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">reachability</span> <span class="o">=</span> <span class="n">reachability</span>
        <span class="k">self</span><span class="o">.</span><span class="n">previousFlags</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">reachabilityNotifier</span> <span class="o">=</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="k">defer</span> <span class="p">{</span>
            <span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="o">.</span><span class="n">finished</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nf">stopListening</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Public</span>
    
    <span class="kd">func</span> <span class="nf">stopListening</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">SCNetworkReachabilitySetCallback</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="kt">SCNetworkReachabilitySetDispatchQueue</span><span class="p">(</span><span class="n">reachability</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">@discardableResult</span>
    <span class="kd">func</span> <span class="nf">startListening</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilityContext</span><span class="p">(</span>
            <span class="nv">version</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nv">info</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="nv">retain</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="nv">release</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="nv">copyDescription</span><span class="p">:</span> <span class="kc">nil</span>
        <span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kt">Unmanaged</span><span class="o">.</span><span class="nf">passUnretained</span><span class="p">(</span><span class="k">self</span><span class="p">)</span><span class="o">.</span><span class="nf">toOpaque</span><span class="p">()</span>
        
        <span class="k">let</span> <span class="nv">callbackEnabled</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilitySetCallback</span><span class="p">(</span>
            <span class="n">reachability</span><span class="p">,</span>
            <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">info</span> <span class="o">=</span> <span class="n">info</span> <span class="p">{</span>
                    <span class="k">let</span> <span class="nv">reachability</span> <span class="o">=</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">NetworkReachability</span><span class="o">&gt;</span>
                        <span class="o">.</span><span class="nf">fromOpaque</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                        <span class="o">.</span><span class="nf">takeUnretainedValue</span><span class="p">()</span>
                    <span class="n">reachability</span><span class="o">.</span><span class="nf">notifyListener</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="o">&amp;</span><span class="n">context</span>
        <span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">queueEnabled</span> <span class="o">=</span> <span class="kt">SCNetworkReachabilitySetDispatchQueue</span><span class="p">(</span>
            <span class="n">reachability</span><span class="p">,</span>
            <span class="n">handlerQueue</span>
        <span class="p">)</span>
        
        <span class="n">handlerQueue</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">notifyListener</span><span class="p">(</span><span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">flagsForCurrentReachability</span> <span class="p">??</span> <span class="o">.</span><span class="nf">init</span><span class="p">())</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="kt">Just</span><span class="p">(</span><span class="n">callbackEnabled</span> <span class="o">&amp;&amp;</span> <span class="n">queueEnabled</span><span class="p">)</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Private</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">reachabilityOfNetworkFor</span><span class="p">(</span>
        <span class="n">_</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">NetworkReachabilityStatus</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">networkStatus</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">unknown</span>
        
        <span class="k">let</span> <span class="nv">isReachable</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">reachable</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">needsConnection</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">connectionRequired</span><span class="p">)</span>
        
        <span class="k">let</span> <span class="nv">canConnectAutomatically</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">connectionOnDemand</span><span class="p">)</span> <span class="o">||</span>
            <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">connectionOnTraffic</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">canConnectWithoutUserInteraction</span> <span class="o">=</span> <span class="n">canConnectAutomatically</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">interventionRequired</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">isNetworkAvailableFlag</span> <span class="o">=</span> <span class="n">isReachable</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="o">!</span><span class="n">needsConnection</span> <span class="o">||</span> <span class="n">canConnectWithoutUserInteraction</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">isNetworkAvailableFlag</span> <span class="p">{</span>
            <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">ethernetOrWiFi</span><span class="p">)</span>
            
            <span class="cp">#if os(iOS)</span>
            <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="nf">contains</span><span class="p">(</span><span class="o">.</span><span class="n">isWWAN</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">wwan</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="cp">#endif</span>
            
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">notReachable</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">networkStatus</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">notifyListener</span><span class="p">(</span><span class="n">_</span> <span class="nv">flags</span><span class="p">:</span> <span class="kt">SCNetworkReachabilityFlags</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">previousFlags</span> <span class="o">!=</span> <span class="n">flags</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">previousFlags</span> <span class="o">=</span> <span class="n">flags</span>
        <span class="k">let</span> <span class="nv">currentNetworkStatus</span> <span class="o">=</span> <span class="nf">reachabilityOfNetworkFor</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
        
        <span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">currentNetworkStatus</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h3 id="3rd-party-solutions">3rd party solutions</h3>

<p>If u don’t want to spend some time and check how to implement this u may use already existing great solutions from <a href="https://developer.apple.com/library/archive/samplecode/Reachability/Introduction/Intro.html#//apple_ref/doc/uid/DTS40007324-Intro-DontLinkElementID_2">Apple</a> or some other developers such as <a href="https://github.com/ashleymills/Reachability.swift/blob/master/Sources/Reachability.swift">Ashley Mills</a></p>

<blockquote>
  <p>To adopt Reachability from Ashley Mills we may wrap her code in to next:</p>
</blockquote>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Combine</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">ReachabilityAshley</span><span class="p">:</span> <span class="kt">NetworkReachabilityProvider</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">networkStatusHandler</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">reachability</span><span class="p">:</span> <span class="kt">Reachability</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">reachabilityNotifier</span><span class="p">:</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">token</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">?()</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">reachability</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Reachability</span><span class="p">()</span>
            <span class="k">self</span><span class="o">.</span><span class="n">reachabilityNotifier</span> <span class="o">=</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">stopListening</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">token</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="n">reachability</span><span class="o">.</span><span class="nf">stopNotifier</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@discardableResult</span>
    <span class="kd">func</span> <span class="nf">startListening</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span>
                <span class="o">.</span><span class="nf">publisher</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="kt">Notification</span><span class="o">.</span><span class="kt">Name</span><span class="o">.</span><span class="n">reachabilityChanged</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">sink</span><span class="p">(</span><span class="nv">receiveValue</span><span class="p">:</span> <span class="n">checkForReachability</span><span class="p">)</span>
            <span class="k">try</span> <span class="n">reachability</span><span class="o">.</span><span class="nf">startNotifier</span><span class="p">()</span>
            <span class="k">return</span> <span class="kt">Just</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="n">token</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="k">return</span> <span class="kt">Just</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="nf">stopListening</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Private</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">checkForReachability</span><span class="p">(</span><span class="n">_</span> <span class="nv">notification</span><span class="p">:</span> <span class="kt">Notification</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">networkReachability</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="n">object</span> <span class="k">as?</span> <span class="kt">Reachability</span>
        <span class="k">var</span> <span class="nv">networkStatus</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">unknown</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">remoteHostStatus</span> <span class="o">=</span> <span class="n">networkReachability</span><span class="p">?</span><span class="o">.</span><span class="n">connection</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">remoteHostStatus</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="n">wifi</span><span class="p">,</span>
                 <span class="o">.</span><span class="nv">cellular</span><span class="p">:</span>
                <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">ethernetOrWiFi</span><span class="p">)</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">unavailable</span><span class="p">:</span>
                <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">notReachable</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">networkStatus</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="network">Network</h2>

<p><a href="https://developer.apple.com/documentation/network"><code class="language-plaintext highlighter-rouge">Network</code></a> is a new framework available for iOS 12+ and dedicated for creating network connections to send and receive data using transport and security protocols.</p>

<p>Within its rich functionality <code class="language-plaintext highlighter-rouge">Network</code> has <code class="language-plaintext highlighter-rouge">NWPathMonitor</code> class that can be used for* monitor and react to network changes*. Usage is much simpler in comparison to <code class="language-plaintext highlighter-rouge">SystemConfiguration</code>. To make it works, we simply create an object and subscribe to any changes, analyzing response:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">Combine</span>
<span class="kd">import</span> <span class="kt">Network</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">NetworkMonitor</span><span class="p">:</span> <span class="kt">NetworkReachabilityProvider</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="k">var</span> <span class="nv">networkStatusHandler</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">monitor</span><span class="p">:</span> <span class="kt">NWPathMonitor</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">handlerQueue</span><span class="p">:</span> <span class="kt">DispatchQueue</span> <span class="o">=</span> <span class="o">.</span><span class="n">main</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">reachabilityNotifier</span><span class="p">:</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span>
    
    <span class="c1">// MARK: - Lifecycle</span>
    
    <span class="kd">public</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">reachabilityNotifier</span> <span class="o">=</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">NetworkReachabilityStatus</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="nf">configureListener</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">deinit</span> <span class="p">{</span>
        <span class="n">monitor</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Public</span>
    
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">stopListening</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">monitor</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="kd">@discardableResult</span>
    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">startListening</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">monitor</span><span class="o">.</span><span class="nf">start</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="n">handlerQueue</span><span class="p">)</span>
        <span class="k">return</span> <span class="kt">Just</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="c1">// MARK: - Private</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">configureListener</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">networkStatus</span><span class="p">:</span> <span class="kt">NetworkReachabilityStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">unknown</span>

        <span class="n">monitor</span><span class="o">.</span><span class="n">pathUpdateHandler</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">path</span> <span class="k">in</span>
            <span class="k">switch</span> <span class="n">path</span><span class="o">.</span><span class="n">status</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nv">satisfied</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="nf">usesInterfaceType</span><span class="p">(</span><span class="o">.</span><span class="n">wifi</span><span class="p">)</span> <span class="o">||</span> <span class="n">path</span><span class="o">.</span><span class="nf">usesInterfaceType</span><span class="p">(</span><span class="o">.</span><span class="n">wiredEthernet</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">ethernetOrWiFi</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="nf">reachable</span><span class="p">(</span><span class="o">.</span><span class="n">wwan</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="o">.</span><span class="n">unsatisfied</span><span class="p">,</span>
                 <span class="o">.</span><span class="nv">requiresConnection</span><span class="p">:</span>
                <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">notReachable</span>
            <span class="kd">@unknown</span> <span class="k">default</span><span class="p">:</span>
                <span class="n">networkStatus</span> <span class="o">=</span> <span class="o">.</span><span class="n">notReachable</span>
            <span class="p">}</span>
            
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">reachabilityNotifier</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">networkStatus</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>As u can see - such solutions are much simpler and compact. But under the hood, it’s using the same mechanisms.</p>

<p>To demonstrate usage of all variants, I created demo app:</p>

<div style="text-align:center">
<img src="/assets/posts/images/2021-01-18-network-reachability/demo.gif" alt="demo" width="300" />
</div>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://developer.apple.com/library/archive/documentation/Networking/Conceptual/SystemConfigFrameworks/SC_ReachConnect/SC_ReachConnect.html#//apple_ref/doc/uid/TP40001065-CH204-BHAFBAHI">SysytemConfiguration programming Guide</a></li>
  <li><a href="https://developer.apple.com/library/archive/samplecode/SimplePing/Introduction/Intro.html">Simple ping</a></li>
  <li><a href="https://developer.apple.com/library/archive/samplecode/Reachability/Introduction/Intro.html#//apple_ref/doc/uid/DTS40007324-Intro-DontLinkElementID_2">Apple Reachability</a></li>
  <li><a href="https://developer.apple.com/documentation/network">Network</a></li>
  <li><a href="https://www.vadimbulavin.com/network-connectivity-on-ios-with-swift/">Network connectivity on ios with swift</a></li>
  <li><a href="https://www.mikeash.com/pyblog/friday-qa-2013-06-14-reachability.html">MikeAsh Friday Q&amp;A 2013-06-14: Reachability</a></li>
</ul>

<p><a href="/assets/posts/images/2021-01-18-network-reachability/source/networkStatus.zip">download source code</a></p>

  </div><a class="u-url" href="/article/2021/01/18/network-reachability.html" hidden></a>
</article>

<div class="prev-next">
  
    <a class="half prev" href="/article/2021/01/11/do-that-instead-of-this.html">&laquo; Do that instead of this</a>
  
  
    <a class="half next" href="/article/2021/01/21/entry-point.html">iOS entry point &raquo;</a>
  
</div>




<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.gplus:hover > svg {fill: #dd4b39;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.gplus > svg {height: 17px; margin-top: 9px; position: relative; left: 1px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=http://localhost:4000/article/2021/01/18/network-reachability.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"/></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('http://twitter.com/home?status=http://localhost:4000/article/2021/01/18/network-reachability.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/article/2021/01/18/network-reachability.html&title=&summary=&source=');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"/></svg></div>
    
    <div class="gplus" title="Share this on Google Plus" onclick="window.open('https://plus.google.com/share?url=http://localhost:4000/article/2021/01/18/network-reachability.html');"><svg viewBox="0 0 2304 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1437 913q0 208-87 370.5t-248 254-369 91.5q-149 0-285-58t-234-156-156-234-58-285 58-285 156-234 234-156 285-58q286 0 491 192l-199 191q-117-113-292-113-123 0-227.5 62t-165.5 168.5-61 232.5 61 232.5 165.5 168.5 227.5 62q83 0 152.5-23t114.5-57.5 78.5-78.5 49-83 21.5-74h-416v-252h692q12 63 12 122zm867-122v210h-209v209h-210v-209h-209v-210h209v-209h210v209h209z"/></svg></div>
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&body=http://localhost:4000/article/2021/01/18/network-reachability.html');"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"/></svg></div>
</div>

<script src="  https://unpkg.com/showdown/dist/showdown.min.js"></script>
<script>
const GH_API_URL = 'https://api.github.com/repos/khorbushko/khorbushko.github.io/issues/24/comments'; // ?client_id=&client_secret=

let request = new XMLHttpRequest();
request.open( 'GET', GH_API_URL, true );
request.onload = function() {
	if ( this.status >= 200 && this.status < 400 ) {
		let response = JSON.parse( this.response );

		for ( var i = 0; i < response.length; i++ ) {
			document.getElementById( 'gh-comments-list' ).appendChild( createCommentEl( response[ i ] ) );
		}

		if ( 0 === response.length ) {
			document.getElementById( 'no-comments-found' ).style.display = 'block';
		}
	} else {
		console.error( this );
	}
};

function createCommentEl( response ) {
	let user = document.createElement( 'a' );
	user.setAttribute( 'href', response.user.url.replace( 'api.github.com/users', 'github.com' ) );
	user.classList.add( 'user' );

	let userAvatar = document.createElement( 'img' );
	userAvatar.classList.add( 'avatar' );
	userAvatar.setAttribute( 'src', response.user.avatar_url );

	user.appendChild( userAvatar );

	let commentLink = document.createElement( 'a' );
	commentLink.setAttribute( 'href', response.html_url );
	commentLink.classList.add( 'comment-url' );
	commentLink.innerHTML = '#' + response.id + ' - ' + response.created_at;

	let commentContents = document.createElement( 'div' );
	commentContents.classList.add( 'comment-content' );
	commentContents.innerHTML = response.body;
	// Progressive enhancement.
	if ( window.showdown ) {
		let converter = new showdown.Converter();
		commentContents.innerHTML = converter.makeHtml( response.body );
	}

	let comment = document.createElement( 'li' );
	comment.setAttribute( 'data-created', response.created_at );
	comment.setAttribute( 'data-author-avatar', response.user.avatar_url );
	comment.setAttribute( 'data-user-url', response.user.url );

	comment.appendChild( user );
	comment.appendChild( commentContents );
	comment.appendChild( commentLink );

	return comment;
}
request.send();
</script>

<hr>

<div class="github-comments">
	<h2>Comments</h2>
	<ul id="gh-comments-list"></ul>
	<p id="leave-a-comment">Join the discussion for this article on <a href="https://github.com/khorbushko/khorbushko.github.io/issues/24">this ticket</a>. Comments appear on this page instantly.</p>
</div>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>RSS</span>      
          </a>
          &nbsp;&nbsp;
          <a href="https://feedrabbit.com/?url=http://khorbushko.github.io">
            <svg class="svg-icon black">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Newsletter</span>      
          </a>

        </p>
        <ul class="contact-list">
          <li class="p-name">khorbushko</li>
          <li><a class="u-email" href="mailto:kirill.ge@gmail.com">kirill.ge@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p>inspired by &quot;software craftsmanship&quot;</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/khorbushko" title="khorbushko"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://stackoverflow.com/users/2012219" title="2012219"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/kyryl-horbushko-67936bb5" title="kyryl-horbushko-67936bb5"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
